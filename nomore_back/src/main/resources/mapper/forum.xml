<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.nomoreback.domain.forum.ForumMapper">
    <resultMap id="forumMap" type="com.korit.nomoreback.domain.forum.Forum">
        <id property="forumId" column="forum_id"/>
        <result property="forumTitle" column="forum_title"/>
        <result property="forumContent" column="forum_content"/>
        <result property="forumCreatedAt" column="forum_created_at"/>
        <result property="forumUpdatedAt" column="forum_updated_at"/>
        <result property="likeCount" column="like_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="isLike" column="is_like"/>
        <association property="moim" resultMap="moimMap"/>
        <association property="forumCategory" resultMap="forumCategoryMap"/>
        <association property="user" resultMap="userMap"/>
        <collection property="forumImgList" select="findImgsByForumId" column="forum_id"
                    ofType="com.korit.nomoreback.domain.forum.ForumImg"/>
    </resultMap>

    <resultMap id="moimMap" type="com.korit.nomoreback.domain.moim.Moim">
        <id property="moimId" column="moim_id"/>
    </resultMap>

    <resultMap id="forumCategoryMap" type="com.korit.nomoreback.domain.forum.ForumCategory">
        <id property="forumCategoryId" column="forum_category_id"/>
        <result property="forumCategoryName" column="forum_category_name"/>
    </resultMap>

    <resultMap id="userMap" type="com.korit.nomoreback.domain.user.User">
        <id property="userId" column="user_id"/>
        <result property="nickName" column="nick_name"/>
        <result property="profileImgPath" column="profile_img_path"/>
    </resultMap>

    <resultMap id="forumImgMap" type="com.korit.nomoreback.domain.forum.ForumImg">
        <id property="forumImgId" column="forum_img_id"/>
        <result property="forumId" column="forum_id"/>
        <result property="seq" column="seq"/>
        <result property="path" column="path"/>
    </resultMap>

    <insert id="registerForum" useGeneratedKeys="true" keyProperty="forumId" keyColumn="forum_id">
        INSERT INTO forum_tb (
            forum_title,
            forum_content,
            forum_created_at,
            moim_id,
            user_id,
            forum_category_id
        ) VALUES (
            #{forumTitle},
            #{forumContent},
            #{forumCreatedAt},
            #{moim.moimId},
            #{user.userId},
            #{forumCategory.forumCategoryId}
        )
    </insert>

    <update id="modifyForum">
        update forum_tb
        <set>
            <if test="forumTitle != null">forum_title = #{forumTitle},</if>
            <if test="forumContent != null">forum_content = #{forumContent},</if>
            <if test="forumCategory != null and forumCategory.forumCategoryId != null">
                forum_category_id = #{forumCategory.forumCategoryId},</if>
            forum_updated_at = now()
        </set>
        where
        forum_id = #{forumId}
    </update>

    <delete id="deleteForum">
        delete from forum_tb
        where forum_id = #{forumId}
    </delete>

    <select id="findByForumIdAndUserId" resultMap="forumMap" parameterType="map">
        select
            f.forum_id,
            f.forum_title,
            f.forum_content,
            f.forum_created_at,
            f.moim_id,
            f.forum_category_id,

            u.user_id,
            u.nick_name,
            u.profile_img_path,

            fc.forum_category_id,
            fc.forum_category_name,

            ifnull(flc.like_count, 0) as like_count,
            ifnull(fcc.comment_count, 0) as comment_count,
            ifnull(flt.forum_like_id, 0) as is_like

        from forum_tb f
            join user_tb u on u.user_id = f.user_id
            join forum_category_tb fc on fc.forum_category_id = f.forum_category_id

        left join (
            select forum_id, count(*) as like_count
            from forum_like_tb
            group by forum_id
        ) flc on flc.forum_id = f.forum_id

        left join (
            select forum_id, count(*) as comment_count
            from forum_comment_tb
            group by forum_id
        ) fcc on fcc.forum_id = f.forum_id

        left join forum_like_tb flt on flt.forum_id = f.forum_id and flt.user_id = #{userId}

        where f.forum_id = #{forumId}
    </select>
  
    <select id="getFourumCategories" resultMap="forumCategoryMap">
        select
            *
        from
            forum_category_tb
    </select>

    <select id="findByForumId" resultMap="forumMap">
        select
            forum_id,
            forum_title,
            forum_content,
            forum_created_at,
            forum_updated_at,
            user_id,
            moim_id,
            forum_category_id
        from
            forum_tb
        where
            forum_id = #{forumId}
    </select>

    <select id="findByMoimId" resultMap="forumMap" parameterType="map">
        select
        f.forum_id,
        f.forum_title,
        f.forum_content,
        f.forum_created_at,
        f.moim_id,
        f.forum_category_id,

        u.user_id,
        u.nick_name,
        u.profile_img_path,

        -- 첫 번째 이미지만 가져오기
        fi.forum_img_id,
        fi.seq,
        fi.path,

        fc.forum_category_id,
        fc.forum_category_name,

        ifnull(flc.like_count, 0) as like_count,
        ifnull(fcc.comment_count, 0) as comment_count,
        ifnull(flt.forum_like_id, 0) as is_like

        from forum_tb f
        join user_tb u on u.user_id = f.user_id
        left join (
        select forum_id, forum_img_id, seq, path
        from forum_img_tb
        where seq = 1   -- 첫 번째 이미지만
        ) fi on fi.forum_id = f.forum_id
        join forum_category_tb fc on fc.forum_category_id = f.forum_category_id

        left join (
        select forum_id, count(*) as like_count
        from forum_like_tb
        group by forum_id
        ) flc on flc.forum_id = f.forum_id

        left join (
        select forum_id, count(*) as comment_count
        from forum_comment_tb
        group by forum_id
        ) fcc on fcc.forum_id = f.forum_id

        left join forum_like_tb flt
        on flt.forum_id = f.forum_id
        and flt.user_id = #{userId}

        where f.moim_id = #{moimId}
    </select>

    <select id="findByCategoryId" resultMap="forumMap">
        select
        f.forum_id,
        f.forum_title,
        f.forum_content,
        f.forum_created_at,
        f.moim_id,
        f.forum_category_id,

        u.user_id,
        u.username,
        u.profile_img_path,

        fi.forum_img_id,
        fi.seq,
        fi.path,

        fc.forum_category_id,
        fc.category_name,

        ifnull(flc.like_count, 0) as like_count,
        ifnull(fcc.comment_count, 0) as comment_count,
        ifnull(flt.id, 0) as is_like

        from forum_tb f
        join user_tb u on u.user_id = f.user_id
        left join forum_img_tb fi on fi.forum_id = f.forum_id
        join forum_category_tb fc on fc.forum_category_id = f.forum_category_id

        left join (
        select forum_id, count(*) as like_count
        from forum_like_tb
        group by forum_id
        ) flc on flc.forum_id = f.forum_id

        left join (
        select forum_id, count(*) as comment_count
        from forum_comment_tb
        group by forum_id
        ) fcc on fcc.forum_id = f.forum_id

        left join forum_like_tb flt
        on flt.forum_id = f.forum_id
        and flt.user_id = #{userId}

        where f.moim_id = #{moimId}
        and f.forum_category_id = #{categoryId}
    </select>

    <select id="findImgsByForumId" resultMap="forumImgMap">
        select forum_img_id, forum_id, seq, path
        from forum_img_tb
        where forum_id = #{forumId}
        order by seq
    </select>
    <select id="findAllByMoimId" resultType="com.korit.nomoreback.domain.forum.Forum">
        select
            ft.forum_id,
            ft.forum_title,
            ft.forum_content,
            ft.created_at,
            ft.user_id,
            ut.fullName,
            ut.profile_img_path
        from forum_tb ft
        left join user_tb ut on ft.user_id = ut.user_id
        where ft.moim_id = #{moimId}
        order by ft.created_at desc
    </select>
</mapper>
