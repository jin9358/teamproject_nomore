<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.nomoreback.domain.moim.MoimMemberMapper">

    <resultMap id="MoimMemberUserMap" type="com.korit.nomoreback.dto.moim.MoimMemberUserDto">
        <id     property="userId"   column="user_id"/>
        <result property="nickname" column="nickname"/>
        <result property="role"     column="role"/>
        <result property="status"   column="status"/>
    </resultMap>

    <select id="findVisibleMembers" resultMap="MoimMemberUserMap">
        SELECT
            u.user_id,
            u.nickname,
            mm.role,
            mm.status
        FROM moim_member_tb mm
        JOIN user_tb u ON u.user_id = mm.user_id
        WHERE
            mm.moim_id = #{moimId}
            AND mm.status = 'JOINED'
            AND NOT EXISTS (
            SELECT 1
            FROM user_block_tb ub
            WHERE ub.blocker_id = #{viewerId}
                AND ub.blocked_id = mm.user_id
            )
        ORDER BY
            CASE mm.role WHEN 'OWNER' THEN 0 WHEN 'MANAGER' THEN 1 ELSE 2 END,
            u.nickname ASC
    </select>

    <update id="updateStatus">
        UPDATE moim_member_tb
        SET status = #{status}
        WHERE moim_id = #{moimId} AND user_id = #{userId}
    </update>

    <select id="findStatus" resultType="string">
        SELECT status
        FROM moim_member_tb
        WHERE moim_id = #{moimId} AND user_id = #{userId}
    </select>

</mapper>
